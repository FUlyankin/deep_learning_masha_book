# 1. Свёртка своими руками

Растровая картинка -- это набор пикселей. Каждый пиксель описывается числом. Чем больше чесло, тем ярче этот пиксель. Шкалы, измеряющие яркость бывают разными. Иногда это числа от 0 до 255, иногда это числа между нулём и единицей. 

У Маши есть картинка (зелёная) и свёртка (голубая), которую она хочет применить к этой картинке[^proof_note].

```{figure} ../images/problem_set_06/img01_conv.png
---
width: 700px
name: regression
---
```
__а)__  Сделайте свёртку картинки без сдвигов и дополнений. К тому, что получилось примените max pooling и average pooling размера $3 \times 3$.


```{dropdown} Решение
Свёртка --- очень простая операция. Наложим маленькую картинку на большую, сделаем поэлементное умножение, сложим числа. Дальше будем двигать маленькую картинку по большой и повторять это.

<img src="../images/problem_set_06/img01_conv_sol_01.png" alt="cnn1" height="150px" align="left">

<img src="../images/problem_set_06/img01_conv_sol_02.png" alt="cnn2" height="150px" align="left">

<img src="../images/problem_set_06/img01_conv_sol_03.png" alt="cnn3" height="150px" align="left">

<img src="../images/problem_set_06/img01_conv_sol_04.png" alt="cnn4" height="150px" align="left">

<img src="../images/problem_set_06/img01_conv_sol_05.png" alt="cnn5" height="150px" align="left">

<img src="../images/problem_set_06/img01_conv_sol_06.png" alt="cnn6" height="150px" align="left">

<img src="../images/problem_set_06/img01_conv_sol_07.png" alt="cnn7" height="150px" align="left">

<img src="../images/problem_set_06/img01_conv_sol_08.png" alt="cnn8" height="150px" align="left">

<img src="../images/problem_set_06/img01_conv_sol_09.png" alt="cnn9" height="150px" align="center">

Собираем получившуюся после применения свёртки картинку.

<img src="../images/problem_set_06/img01_conv_sol_10.png" alt="cnn9" height="120px" align="center">

Размерность исходной картинки была $4 \times 4$. После применения свёртки она уменьшилась до $3 \times 3$. Это неудобно. Хочется контролировать понижение размерности картинки самостоятельно. Для этого можно дополнить картинку рамкой из нулей. Размер рамки подбирается так, чтобы размерность картинки не упала, Такой приём называется **дополнением (padding)**

Чтобы уменьшать размерность картинки, используют пулинг. Картинку бьют на квадратики рамзера $k \times k$, из каждого из них берут максимум или среднее. 

**Max pooling:**

$$
\max(12,12,17,15,19,21,18,18,24) = 24
$$

**Avg pooling:**

$$
\frac{1}{9} \cdot (12 + 12 + 17 + 15 + 19 + 21 + 18 + 18 + 24) = 17.3
$$

```

__б)__  Примените к исходной картинке свёртку с параметром сдвига (stride) равным $2$.


```{dropdown} Решение
При свёртке можно прикладывать ядро не к каждой клетке. На картинке ниже выделены клетки, к которым мы будем прикладывать **ядро свёртки.**

<img src="../images/problem_set_06/img01_conv_b_sol_01.png" alt="cnn9" height="180px" align="center">

Обратите внимание, что мы делаем сдвиг по обеим осям. Можно делать разные сдвиги по разным осям. Правда не очень ясно, когда это оправдано. 

<img src="../images/problem_set_06/img01_conv_b_sol_02.png" alt="cnn9" height="180px" align="center">

На выходе получим картинку 

<img src="../images/problem_set_06/img01_conv_b_sol_03.png" alt="cnn9" height="100px" align="center">

```

__в)__  Примените к исходной картинке свёртку с дополнением нулями (zero padding) и параметром сдвига (stride) равным $1$.


```{dropdown} Решение
Нам надо сделать вокруг картинки каёмку из нулей и применить свёртку с её учётом. Благодаря этому, размерность исходного изображения не упадёт и мы сможем более аккуратно контролировать изменение её размеров. Проиллюстрируем первые два шага такой свёртки. К остальным клеткам применение будет делаться аналогично. Параметр сдвига, равный единице, означает, что мы прикладываем ядро к каждой из клеток.

<img src="../images/problem_set_06/img01_conv_c_sol_01.png" alt="cnn9" height="180px" align="center">

```

__г)__  Сделайте расширенную свёртку (dilated convolutioon) с параметром расширения равным $2$ (dilation factor). Сравните такую свёртку с обычной свёрткой со сдвигом. Эквивалентны ли они?  


```{dropdown} Решение
Нам надо сделать расширенную свёртку (dilated convolution) с параметром расширения равным $2$. 

<img src="../images/problem_set_06/img01_conv_d_sol_01.png" alt="cnn9" height="180px" align="center">

Смысл этой свёртки в том, что соседние пиксели картинки очень похожи. Нет смысла смотреть на два соседних пикселя, так как в них будет одна и та же информация. Давайте накладывать свёртку на картинку более разряжено. Это поможет быстрее нарастить поле обзора (receptive field). В свёртках со сдвигом похожая идея, но вместо того, чтобы делать свёртку более разреженной, мы быстрее двигаемся по картинке. 

```

[^proof_note]: Эта и часть других задачек из этого листочка составлены по [мотивам виньетки про арифметику свёрток.](https://arxiv.org/pdf/1603.07285.pdf)
